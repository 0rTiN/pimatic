<!DOCTYPE html><html lang="en"><head><title>lib/rules</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/rules"><meta name="groc-project-path" content="lib/rules.coffee"><meta name="groc-github-url" content="https://github.com/sweetpi/pimatic"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><link rel="stylesheet" type="text/css" media="all" href="../assets/customStyle.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sweetpi/pimatic/blob/master/lib/rules.coffee">lib/rules.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="rules-handling">rules handling</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">assert = </span><span class="nx">require</span> <span class="s">&#39;cassert&#39;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;./logger&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">Q = </span><span class="nx">require</span> <span class="s">&#39;q&#39;</span>
<span class="nv">milliseconds = </span><span class="nx">require</span> <span class="s">&#39;./milliseconds&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="rulemanager">RuleManager</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">RuleManager</span> <span class="k">extends</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Array of the added rules
If a rule was successfully added, the rule has the form:</p>

<pre><code>id: 'some-id'
string: 'if its 10pm and light is on then turn the light off'
orgCondition: 'its 10pm and light is on'
predicates: [
  { id: 'some-id0'
    provider: the corresponding provider },
  { id: 'some-id1'
    provider: the corresponding provider }
]
tokens: ['predicate', '(', 0, ')', 'and', 
         'predicate', '(', 1, ')' ] 
action: 'turn the light off'
active: false or true
</code></pre>

<p>If the rule had an error:</p>

<pre><code>id: id
string: 'if bla then blub'
error: 'Could not find a provider that decides bla'
active: false 
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nv">rules: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Array of ActionHandlers: see <a href="actions.html">actions.coffee</a></p></div></div><div class="code"><div class="wrapper">  <span class="nv">actionHandlers: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Array of predicateProviders: see <a href="actions.html">actions.coffee</a></p></div></div><div class="code"><div class="wrapper">  <span class="nv">predicateProviders: </span><span class="p">[]</span>

  <span class="nv">constructor: </span><span class="nf">(@framework) -&gt;</span>

  <span class="nv">addActionHandler: </span><span class="nf">(ah) -&gt;</span> <span class="nx">@actionHandlers</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ah</span>
  <span class="nv">addPredicateProvider: </span><span class="nf">(pv) -&gt;</span> <span class="nx">@predicateProviders</span><span class="p">.</span><span class="nx">push</span> <span class="nx">pv</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="parserulestring">parseRuleString</h3>

<p>This function parses a rule given by a string and returns a rule object.
A rule string is for example 'if its 10pm and light is on then turn the light off'
it get parsed to the follwoing rule object:</p>

<pre><code>id: 'some-id'
string: 'if its 10pm and light is on then turn the light off'
orgCondition: 'its 10pm and light is on'
predicates: [
  { id: 'some-id0'
    provider: the corresponding provider },
  { id: 'some-id1'
    provider: the corresponding provider }
]
tokens: ['predicate', '(', 0, ')', 'and', 
         'predicate', '(', 1, ')' ] 
action: 'turn the light off'
active: false or true
</code></pre>

<p>The function returns a promise!</p></div></div><div class="code"><div class="wrapper">  <span class="nv">parseRuleString: </span><span class="nf">(id, ruleString) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">id</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nx">assert</span> <span class="nx">ruleString</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">ruleString</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span>

    <span class="nv">rule = </span>
      <span class="nv">id: </span><span class="nx">id</span>
      <span class="nv">string: </span><span class="nx">ruleString</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allways return a promise</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First take the string apart, so that 
<code>parts</code> gets <code>["", "its 10pm and light is on", "turn the light off"]</code>.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">parts = </span><span class="nx">ruleString</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/^if\s|\sthen\s/</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check for the right parts count. Note the empty string at the beginning</p></div></div><div class="code"><div class="wrapper">      <span class="k">switch</span>
        <span class="k">when</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;The rule must start with &quot;if&quot; and contain a &quot;then&quot; part!&#39;</span><span class="p">)</span>
        <span class="k">when</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span> 
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;The rule must exactly contain one &quot;if&quot; and one &quot;then&quot;!&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now <code>condition</code> gets <code>"its 10pm and light is on"</code></p></div></div><div class="code"><div class="wrapper">      <span class="nv">rule.orgCondition = </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and <code>actions</code> gets <code>" turn the light off"</code>.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">rule.action = </span><span class="nx">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Utility function, that finds a provider, that can decide the given predicate like <code>its 10pm</code></p></div></div><div class="code"><div class="wrapper">      <span class="nv">findPredicateProvider = </span><span class="nf">(predicate) =&gt;</span>
        <span class="nx">assert</span> <span class="nx">predicate</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">predicate</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="nx">provider</span> <span class="k">in</span> <span class="nx">@predicateProviders</span>
          <span class="nv">type = </span><span class="nx">provider</span><span class="p">.</span><span class="nx">canDecide</span> <span class="nx">predicate</span>
          <span class="nx">assert</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;state&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="kc">no</span>
          <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;state&#39;</span>
            <span class="k">return</span> <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">provider</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now split the condition in a token stream.
For example: <code>"12:30 and temperature &gt; 10"</code> becomes 
<code>['12:30', 'and', 'temperature &gt; 30 C']</code>
Then we replace all predicates throw predicate tokens:
<code>['predicate', '(', 0, ')', 'and', 'predicate', '(', 1, ')']</code>
and remember the predicates:
<code>predicates = [ {token: '12:30'}, {token: 'temperature &gt; 10'}]</code></p></div></div><div class="code"><div class="wrapper">      <span class="nv">predicates = </span><span class="p">[]</span>
      <span class="nv">tokens = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">token</span> <span class="k">in</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">orgCondition</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/(\sand\s|\sor\s|\)|\()/</span> 
        <span class="nx">do</span> <span class="nf">(token) =&gt;</span>
          <span class="nv">token = </span><span class="nx">token</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
          <span class="k">if</span> <span class="nx">token</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;and&quot;</span><span class="p">,</span> <span class="s">&quot;or&quot;</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">]</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span> <span class="nx">token</span>
          <span class="k">else</span>
            <span class="nv">i = </span><span class="nx">predicates</span><span class="p">.</span><span class="nx">length</span>
            <span class="nv">predId = </span><span class="nx">id</span><span class="o">+</span><span class="nx">i</span>

            <span class="nv">forSuffix = </span><span class="kc">null</span>
            <span class="nv">forTime = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Try to split the predicate at the last <code>for</code> to handle 
predicates in the form <code>"the light is on for 10 seconds"</code></p></div></div><div class="code"><div class="wrapper">            <span class="nv">forMatches = </span><span class="nx">token</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/(.+)\sfor\s(.+)/</span>
            <span class="k">if</span> <span class="nx">forMatches</span><span class="o">?</span> <span class="o">and</span> <span class="nx">forMatches</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span>
              <span class="nv">beforeFor = </span><span class="nx">forMatches</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>
              <span class="nv">afterFor = </span><span class="nx">forMatches</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Test if we can parse the afterFor part.</p></div></div><div class="code"><div class="wrapper">              <span class="nv">ms = </span><span class="nx">milliseconds</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">afterFor</span>
              <span class="k">if</span> <span class="nx">ms</span><span class="o">?</span>
                <span class="nv">token = </span><span class="nx">beforeFor</span>
                <span class="nv">forSuffix = </span><span class="nx">afterFor</span>
                <span class="nv">forTime = </span><span class="nx">ms</span>

            <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">provider</span><span class="p">]</span> <span class="o">=</span> <span class="nx">findPredicateProvider</span> <span class="nx">token</span>
            <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span> <span class="o">and</span> <span class="nx">forSuffix</span><span class="o">?</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;\&quot;</span><span class="si">#{</span><span class="nx">token</span><span class="si">}</span><span class="s">\&quot; is an event it can not be true for \&quot;</span><span class="si">#{</span><span class="nx">forSuffix</span><span class="si">}</span><span class="s">\&quot;&quot;</span>

            <span class="nv">predicate =</span>
              <span class="nv">id: </span><span class="nx">predId</span>
              <span class="nv">token: </span><span class="nx">token</span>
              <span class="nv">type: </span><span class="nx">type</span>
              <span class="nv">provider: </span><span class="nx">provider</span>
              <span class="nv">forToken: </span><span class="nx">forSuffix</span>
              <span class="k">for</span><span class="o">:</span> <span class="nx">forTime</span>

            <span class="k">if</span> <span class="o">not</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">provider</span><span class="o">?</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Could not find an provider that decides \&quot;</span><span class="si">#{</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">token</span><span class="si">}</span><span class="s">\&quot;&quot;</span>

            <span class="nx">predicates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">predicate</span><span class="p">)</span>
            <span class="nv">tokens = </span><span class="nx">tokens</span><span class="p">.</span><span class="nx">concat</span> <span class="p">[</span><span class="s">&quot;predicate&quot;</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">]</span>
              
      <span class="nv">rule.tokens = </span><span class="nx">tokens</span>
      <span class="nv">rule.predicates = </span><span class="nx">predicates</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Simulate the action execution to try if it can be executed-</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">@executeAction</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the execution was sussessful then return the rule object.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">rule</span> 
      <span class="p">).</span><span class="nx">catch</span><span class="p">(</span> <span class="nf">(error) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there was a Errror simulation the action exeution, return an error.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">error</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Could not find a actuator to execute \&quot;</span><span class="si">#{</span><span class="nx">rule</span><span class="p">.</span><span class="nx">action</span><span class="si">}</span><span class="s">\&quot;&quot;</span>
      <span class="p">)</span>
    <span class="p">).</span><span class="nx">catch</span><span class="p">(</span> <span class="nf">(error) =&gt;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;rethrowing error: </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stack</span>
      <span class="nv">error.rule = </span><span class="nx">rule</span>
      <span class="k">throw</span> <span class="nx">error</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-whenpredicateistrue">_whenPredicateIsTrue</h3>

<p>Register for every predicate the callback function that should be called
when the predicate becomes true.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_registerPredicateProviderNotify: </span><span class="nf">(rule) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">rule</span><span class="o">?</span>
    <span class="nx">assert</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">predicates</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="whenpredicateistrue">whenPredicateIsTrue</h3>

<p>This function should be called by a provider if a predicate becomes true</p></div></div><div class="code"><div class="wrapper">    <span class="nv">whenPredicateIsTrue = </span><span class="nf">(ruleId, predicateId, state) =&gt;</span>
      <span class="nx">assert</span> <span class="nx">ruleId</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">ruleId</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">ruleId</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">assert</span> <span class="nx">predicateId</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">predicateId</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">predicateId</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">assert</span> <span class="nx">state</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span> <span class="o">or</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First get get the corresponding rule</p></div></div><div class="code"><div class="wrapper">      <span class="nv">rule = </span><span class="nx">@rules</span><span class="p">[</span><span class="nx">ruleId</span><span class="p">]</span>
      <span class="k">unless</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">active</span> <span class="k">then</span> <span class="k">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then mark the given predicate as true</p></div></div><div class="code"><div class="wrapper">      <span class="nv">knownPredicates = </span><span class="p">{}</span>
      <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">predicateId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and check if the rule is now true.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@doesRuleCondtionHold</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">knownPredicates</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(isTrue) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if the rule is now true, then execute its action</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">isTrue</span> <span class="k">then</span> <span class="nx">@executeActionAndLogResult</span><span class="p">(</span><span class="nx">rule</span><span class="p">).</span><span class="nx">done</span><span class="p">()</span>
        <span class="k">return</span>
      <span class="p">).</span><span class="nx">done</span><span class="p">()</span>
      <span class="k">return</span>
    </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Register the whenPredicateIsTrue for all providers:</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">predicates</span>
      <span class="nx">do</span> <span class="nf">(p) =&gt;</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">notifyWhen</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="nf">(state) =&gt;</span>
          <span class="nx">assert</span> <span class="nx">state</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span> <span class="o">or</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="k">if</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">state</span> <span class="o">is</span> <span class="s">&#39;event&#39;</span>
            <span class="nx">whenPredicateIsTrue</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">state</span>
          </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-cancelpredicateprovidernotify">_cancelPredicateproviderNotify</h3>

<p>Cancels for every predicate the callback that should be called
when the predicate becomes true.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_cancelPredicateProviderNotify: </span><span class="nf">(rule) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">rule</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then cancel the notifier for all predicates</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">valid</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">cancelNotify</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">predicates</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="addrulebystring">AddRuleByString</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">addRuleByString: </span><span class="nf">(id, ruleString, active=yes, force=false) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">id</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nx">assert</span> <span class="nx">ruleString</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">ruleString</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First parse the rule.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@parseRuleString</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ruleString</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(rule)=&gt;</span>
      <span class="nx">@_registerPredicateProviderNotify</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the rules was successful parsed add it to the rule array.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">rule.active = </span><span class="nx">active</span>
      <span class="nv">rule.valid = </span><span class="kc">yes</span>
      <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span>
      <span class="nx">@emit</span> <span class="s">&quot;add&quot;</span><span class="p">,</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check if the condition of the rule is allready true.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">active</span>
        <span class="nx">@doesRuleCondtionHold</span><span class="p">(</span><span class="nx">rule</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(isTrue) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the confition is true then execute the action.</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">isTrue</span> 
            <span class="nx">@executeActionAndLogResult</span><span class="p">(</span><span class="nx">rule</span><span class="p">).</span><span class="nx">done</span><span class="p">()</span>
          <span class="k">return</span>
        <span class="p">).</span><span class="nx">done</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="p">).</span><span class="nx">catch</span><span class="p">(</span> <span class="nf">(error) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there was an error pasring the rule, but the rule is forced to be added, then add
the rule with an error</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">force</span>
        <span class="k">if</span> <span class="nx">error</span><span class="p">.</span><span class="nx">rule</span><span class="o">?</span>
          <span class="nv">rule = </span><span class="nx">error</span><span class="p">.</span><span class="nx">rule</span>
          <span class="nv">rule.error = </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
          <span class="nv">rule.active = </span><span class="kc">false</span>
          <span class="nv">rule.valid = </span><span class="kc">no</span>
          <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span>
          <span class="nx">@emit</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nx">rule</span>
        <span class="k">else</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&#39;Could not force add rule, because error had no rule attribute.&#39;</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">error</span>
      <span class="k">throw</span> <span class="nx">error</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="removerule">removeRule</h3>

<p>Removes a rule, from the RuleManager</p></div></div><div class="code"><div class="wrapper">  <span class="nv">removeRule: </span><span class="nf">(id) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">id</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Invalid ruleId: \&quot;</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">\&quot;&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First get the rule from the rule array.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">rule = </span><span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then get cancel all notifies</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@_cancelPredicateProviderNotify</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and delete the rule from the array</p></div></div><div class="code"><div class="wrapper">    <span class="k">delete</span> <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and emit the event.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@emit</span> <span class="s">&quot;remove&quot;</span><span class="p">,</span> <span class="nx">rule</span>
    <span class="k">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="updaterulebystring">updateRuleByString</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">updateRuleByString: </span><span class="nf">(id, ruleString, active=yes) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">id</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">id</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="nx">assert</span> <span class="nx">ruleString</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">ruleString</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;Invalid ruleId: \&quot;</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">\&quot;&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First try to parse the updated ruleString.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@parseRuleString</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ruleString</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(rule)=&gt;</span>
      <span class="nv">rule.active = </span><span class="nx">active</span>
      <span class="nv">rule.valid = </span><span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the rule was successfully parsed then get the old rule</p></div></div><div class="code"><div class="wrapper">      <span class="nv">oldRule = </span><span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and cancel the notifier for the old predicates.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@_cancelPredicateProviderNotify</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and register the new ones:</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@_registerPredicateProviderNotify</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then add the rule to the rules array</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@rules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and emit the event.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@emit</span> <span class="s">&quot;update&quot;</span><span class="p">,</span> <span class="nx">rule</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then check if the condition of the rule is now true.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">active</span>
        <span class="nx">@doesRuleCondtionHold</span><span class="p">(</span><span class="nx">rule</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(isTrue) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the condition is true then exectue the action.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="k">if</span> <span class="nx">isTrue</span> <span class="k">then</span> <span class="nx">@executeActionAndLogResult</span><span class="p">(</span><span class="nx">rule</span><span class="p">).</span><span class="nx">done</span><span class="p">()</span>
        <span class="p">).</span><span class="nx">done</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="evaluateconditionofrule">evaluateConditionOfRule</h3>

<p>Uses 'bet' to evaluate rule.tokens</p></div></div><div class="code"><div class="wrapper">  <span class="nv">evaluateConditionOfRule: </span><span class="nf">(rule, knownPredicates = {}) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">rule</span><span class="o">?</span> <span class="o">and</span> <span class="nx">rule</span> <span class="k">instanceof</span> <span class="nb">Object</span>
    <span class="nx">assert</span> <span class="nx">knownPredicates</span><span class="o">?</span> <span class="o">and</span> <span class="nx">knownPredicates</span> <span class="k">instanceof</span> <span class="nb">Object</span>

    <span class="nv">awaiting = </span><span class="p">[]</span>
    <span class="nv">predNumToId = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">pred</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">predicates</span>
      <span class="nx">do</span> <span class="nf">(pred) =&gt;</span>
        <span class="nx">predNumToId</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">unless</span> <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
          <span class="nx">awaiting</span><span class="p">.</span><span class="nx">push</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">isTrue</span><span class="p">(</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">token</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(state) =&gt;</span>
            <span class="k">unless</span> <span class="nx">state</span><span class="o">?</span>
              <span class="nv">state = </span><span class="kc">false</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Could not decide </span><span class="si">#{</span><span class="nx">pred</span><span class="p">.</span><span class="nx">token</span><span class="si">}</span><span class="s"> yet.&quot;</span>
            <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span>

    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">awaiting</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(predicateValues) =&gt;</span>
      <span class="nv">bet = </span><span class="nx">require</span> <span class="s">&#39;bet&#39;</span>
      <span class="nx">bet</span><span class="p">.</span><span class="nx">operators</span><span class="p">[</span><span class="s">&#39;and&#39;</span><span class="p">]</span> <span class="o">=</span>
        <span class="nv">assoc: </span><span class="s">&#39;left&#39;</span>
        <span class="nv">prec: </span><span class="mi">0</span>
        <span class="nv">argc: </span><span class="mi">2</span>
        <span class="nv">fix: </span><span class="s">&#39;in&#39;</span>
        <span class="nv">exec: </span><span class="nf">(args) =&gt;</span> <span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="nx">bet</span><span class="p">.</span><span class="nx">operators</span><span class="p">[</span><span class="s">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span>
        <span class="nv">assoc: </span><span class="s">&#39;left&#39;</span>
        <span class="nv">prec: </span><span class="mi">1</span>
        <span class="nv">argc: </span><span class="mi">2</span>
        <span class="nv">fix: </span><span class="s">&#39;in&#39;</span>
        <span class="nv">exec: </span><span class="nf">(args) =&gt;</span> <span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="nx">bet</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="s">&#39;predicate&#39;</span><span class="p">]</span> <span class="o">=</span>
      <span class="nv">argc: </span><span class="mi">1</span>
      <span class="nv">exec: </span><span class="nf">(args) =&gt;</span> 
        <span class="nv">predId = </span><span class="nx">predNumToId</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="nx">assert</span> <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">predId</span><span class="p">]</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">predId</span><span class="p">]</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>

      <span class="nv">isTrue = </span><span class="p">(</span><span class="nx">bet</span><span class="p">.</span><span class="nx">evaluateSync</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">tokens</span><span class="p">)</span> <span class="o">is</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">isTrue</span>
    <span class="p">)</span>


  <span class="nv">doesRuleCondtionHold: </span><span class="nf">(rule, knownPredicates = {}) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">rule</span><span class="o">?</span> <span class="o">and</span> <span class="nx">rule</span> <span class="k">instanceof</span> <span class="nb">Object</span>   
    <span class="nx">assert</span> <span class="nx">knownPredicates</span><span class="o">?</span> <span class="o">and</span> <span class="nx">knownPredicates</span> <span class="k">instanceof</span> <span class="nb">Object</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>First evaluate the condition and</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">@evaluateConditionOfRule</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">knownPredicates</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(isTrue) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if the condition is false then the condition con not hold, because it is already false
so return false.</p></div></div><div class="code"><div class="wrapper">      <span class="k">unless</span> <span class="nx">isTrue</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Some predicates could have a 'for'-Suffix like 'for 10 seconds' then the predicates 
must at least hold for 10 seconds to be true, so we have to wait 10 seconds to decide
if the rule is realy true</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a deferred that will be resolve with the return value when the decision can be made. </p></div></div><div class="code"><div class="wrapper">      <span class="nv">deferred = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We will collect all predicates that have a for suffix and are not yet decideable in an 
awaiting list.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">awaiting = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Whenever an awaiting predicate gets resolved then we will revalidate the rule condition.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">revalidateCondition = </span><span class="p">()</span> <span class="o">=&gt;</span>
        <span class="nx">@evaluateConditionOfRule</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">knownPredicates</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(isTrueNew) =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If it is true</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">isTrueNew</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then resolve the return value as true</p></div></div><div class="code"><div class="wrapper">            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and cancel all awaitings.</p></div></div><div class="code"><div class="wrapper">            <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">a</span> <span class="k">of</span> <span class="nx">awaiting</span>
              <span class="nx">a</span><span class="p">.</span><span class="nx">cancel</span><span class="p">()</span>
            <span class="k">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Else check if we have awaiting predicates.
If we have no awaiting predicates</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">awaiting</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then we can resolve the return value as false</p></div></div><div class="code"><div class="wrapper">            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">false</span> 
        <span class="p">.</span><span class="nx">done</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fill the awaiting list:
Check for each predicate,</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">pred</span> <span class="k">in</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">predicates</span>
        <span class="nx">do</span> <span class="nf">(pred) =&gt;</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if it has a for suffix.</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">for</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If it has a for suffix and its an event something gone wrong, because an event can't 
hold (its just one time)</p></div></div><div class="code"><div class="wrapper">            <span class="nx">assert</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;state&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a new predicate id so we can register another listener.</p></div></div><div class="code"><div class="wrapper">            <span class="nv">idNew = </span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s">&quot;-for-&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">())</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Mark that we are awaiting the result</p></div></div><div class="code"><div class="wrapper">            <span class="nx">awaiting</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and as long as we are awaiting the result, the predicate is false.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>When the time passes</p></div></div><div class="code"><div class="wrapper">            <span class="nv">timeout = </span><span class="nx">setTimeout</span> <span class="o">=&gt;</span>
              <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the predicate remains true and no value is awaited anymore.</p></div></div><div class="code"><div class="wrapper">              <span class="nx">awaiting</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">cancel</span><span class="p">()</span>
              <span class="nx">revalidateCondition</span><span class="p">()</span>
            <span class="p">,</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">for</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Let us be notified when it becomes false.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">pred</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">notifyWhen</span> <span class="nx">idNew</span><span class="p">,</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="nf">(state) =&gt;</span>
              <span class="nx">assert</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If it changes to false</p></div></div><div class="code"><div class="wrapper">              <span class="k">if</span> <span class="nx">state</span> <span class="o">is</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then the predicate is false</p></div></div><div class="code"><div class="wrapper">                <span class="nx">knownPredicates</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and clear the timeout.</p></div></div><div class="code"><div class="wrapper">                <span class="nx">awaiting</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">cancel</span><span class="p">()</span>
                <span class="nx">revalidateCondition</span><span class="p">()</span>

            <span class="nx">awaiting</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nv">cancel = </span><span class="o">=&gt;</span>
              <span class="k">delete</span> <span class="nx">awaiting</span><span class="p">[</span><span class="nx">pred</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
              <span class="nx">clearTimeout</span> <span class="nx">timeout</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and we can cancel the notify</p></div></div><div class="code"><div class="wrapper">              <span class="nx">pred</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">cancelNotify</span> <span class="nx">idNew</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have not found awaiting predicates</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="k">for</span> <span class="nx">id</span> <span class="k">of</span> <span class="nx">awaiting</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then resolve the return value to true.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="kc">true</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>At then end return the deferred promise. </p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span>
    <span class="p">)</span>
    
  <span class="nv">executeActionAndLogResult: </span><span class="nf">(rule) -&gt;</span>
    <span class="k">return</span> <span class="nx">@executeAction</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span> <span class="kc">false</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(message) =&gt;</span>
      <span class="k">if</span> <span class="nx">message</span><span class="o">?</span> <span class="k">then</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Rule </span><span class="si">#{</span><span class="nx">rule</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="p">).</span><span class="nx">catch</span><span class="p">(</span> <span class="nf">(error)=&gt;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Rule </span><span class="si">#{</span><span class="nx">rule</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s"> error: </span><span class="si">#{</span><span class="nx">error</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="executeaction">executeAction</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">executeAction: </span><span class="nf">(actionString, simulate) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">actionString</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">actionString</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> 
    <span class="nx">assert</span> <span class="nx">simulate</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">simulate</span> <span class="o">is</span> <span class="s">&quot;boolean&quot;</span>

    <span class="k">for</span> <span class="nx">aH</span> <span class="k">in</span> <span class="nx">@actionHandlers</span>
      <span class="nv">promise = </span><span class="nx">aH</span><span class="p">.</span><span class="nx">executeAction</span> <span class="nx">actionString</span><span class="p">,</span> <span class="nx">simulate</span>
      <span class="k">if</span> <span class="nx">promise</span><span class="o">?</span><span class="p">.</span><span class="nx">then</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">promise</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span> <span class="o">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&quot;No actionhandler found!&quot;</span><span class="p">)</span>

<span class="nv">module.exports.RuleManager = </span><span class="nx">RuleManager</span></div></div></div></div></body></html>